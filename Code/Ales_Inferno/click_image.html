<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>El Bugueo</title>
  <!-- Event listener vs Raycaster -->
  <!-- I fixed it; everything that relies on the mesh array needs to go inside the closure. -->
  <!-- https://discourse.threejs.org/t/how-do-i-add-click-event-to-a-mesh/43837/3 -->
  <link href="/favicon.ico" rel="icon" type="image/x-icon">
  <script src="/build/three.min.js"></script>
  <style>
    .overlay-element {
      pointer-events: none;
    }

    body {
      margin: 0;
    }

    canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
<script>
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.z = 2;

  const renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // todo: Note! Can't add event listener to a mesh; it needs to be raycasted.
  // Click event listener function
  // function onImageClick() {
  //   console.log('onImageClick');
  // }
  // Mousedown event listener function
  // function onImageMouseDown() {
  //   console.log('onImageMouseDown');
  // }

  // Create a TextureLoader instance
  const textureLoader = new THREE.TextureLoader();

  // Create a global raycaster
  const raycaster = new THREE.Raycaster();

  // Load the image texture
  textureLoader.load('/images/image1.jpg', function (texture) {
    // Create a list to store objects for raycasting
    const clickableObjects = [];

    // Create a PlaneGeometry with the desired size
    const geometry = new THREE.PlaneGeometry(1, 1);

    // Create a MeshBasicMaterial with the loaded texture
    const material = new THREE.MeshBasicMaterial({ map: texture });

    // Create a mesh using the geometry and material
    const mesh = new THREE.Mesh(geometry, material);
    mesh.scale.set(1.0, texture.image.height / texture.image.width, 1.0);
    mesh.userData.interactive = true; // we set it, but we don't check it
    mesh.name = "image1";

    // Add the mesh to the scene
    scene.add(mesh);

    // Add the mesh to the list of clickable objects
    clickableObjects.push(mesh);

    // todo: again, can't add event listener to a mesh
    // Add the 'mousedown' event listener after the image has loaded
    // mesh.addEventListener('mousedown', onImageMouseDown);
    // Add the 'click' event listener after the image has loaded
    // mesh.addEventListener('click', onImageClick);

    // CHECK CLICKABLE OBJECTS
    if (clickableObjects.length > 0) {
      console.log("%cGweat!", "color: #ccff00;", clickableObjects);
    } else {
      console.log("%cNope!", "color: #ff00cc;", clickableObjects);
    }

    // Event listener for mouse clicks
    function onMouseDown(event) {
      // Calculate the mouse position in normalized device coordinates (-1 to +1)
      const mouse = new THREE.Vector2();
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      // Update the picking ray with the camera and mouse position
      raycaster.setFromCamera(mouse, camera);

      // Raycast against the list of clickable objects
      const intersects = raycaster.intersectObjects(clickableObjects);

      // Check if any objects were intersected
      if (intersects.length > 0) {
        console.log('Image clicked!');
      }
    }

    // Attach the mouse down event listener to the canvas
    renderer.domElement.addEventListener('mousedown', onMouseDown);
  });

  window.addEventListener('resize', function () {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }

  animate();
</script>
</body>
</html>
